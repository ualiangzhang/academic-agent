"use strict";var __runInitializers=exports&&exports.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=exports&&exports.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(f!==void 0&&typeof f!="function")throw new TypeError("Function expected");return f}for(var kind=contextIn.kind,key=kind==="getter"?"get":kind==="setter"?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),_,done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]=p==="access"?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])(kind==="accessor"?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if(kind==="accessor"){if(result===void 0)continue;if(result===null||typeof result!="object")throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&(kind==="field"?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EdgeFunction=void 0;var jsiiDeprecationWarnings=()=>{var tmp=require("../../../.warnings.jsii.js");return jsiiDeprecationWarnings=()=>tmp,tmp};const JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti");var iam=()=>{var tmp=require("../../../aws-iam");return iam=()=>tmp,tmp},lambda=()=>{var tmp=require("../../../aws-lambda");return lambda=()=>tmp,tmp},ssm=()=>{var tmp=require("../../../aws-ssm");return ssm=()=>tmp,tmp},core_1=()=>{var tmp=require("../../../core");return core_1=()=>tmp,tmp},metadata_resource_1=()=>{var tmp=require("../../../core/lib/metadata-resource");return metadata_resource_1=()=>tmp,tmp},prop_injectable_1=()=>{var tmp=require("../../../core/lib/prop-injectable");return prop_injectable_1=()=>tmp,tmp},cross_region_string_param_reader_provider_generated_1=()=>{var tmp=require("../../../custom-resource-handlers/dist/aws-cloudfront/cross-region-string-param-reader-provider.generated");return cross_region_string_param_reader_provider_generated_1=()=>tmp,tmp};let EdgeFunction=(()=>{let _classDecorators=[prop_injectable_1().propertyInjectable],_classDescriptor,_classExtraInitializers=[],_classThis,_classSuper=core_1().Resource,_instanceExtraInitializers=[],_addAlias_decorators,_addEventSourceMapping_decorators,_addPermission_decorators,_addToRolePolicy_decorators,_grantInvoke_decorators,_grantInvokeLatestVersion_decorators,_grantInvokeVersion_decorators,_grantInvokeUrl_decorators,_grantInvokeCompositePrincipal_decorators,_metric_decorators,_metricDuration_decorators,_metricErrors_decorators,_metricInvocations_decorators,_metricThrottles_decorators,_addEventSource_decorators,_configureAsyncInvoke_decorators,_addFunctionUrl_decorators;var EdgeFunction2=class extends _classSuper{static{_classThis=this}static{const _metadata=typeof Symbol=="function"&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;_addAlias_decorators=[(0,metadata_resource_1().MethodMetadata)()],_addEventSourceMapping_decorators=[(0,metadata_resource_1().MethodMetadata)()],_addPermission_decorators=[(0,metadata_resource_1().MethodMetadata)()],_addToRolePolicy_decorators=[(0,metadata_resource_1().MethodMetadata)()],_grantInvoke_decorators=[(0,metadata_resource_1().MethodMetadata)()],_grantInvokeLatestVersion_decorators=[(0,metadata_resource_1().MethodMetadata)()],_grantInvokeVersion_decorators=[(0,metadata_resource_1().MethodMetadata)()],_grantInvokeUrl_decorators=[(0,metadata_resource_1().MethodMetadata)()],_grantInvokeCompositePrincipal_decorators=[(0,metadata_resource_1().MethodMetadata)()],_metric_decorators=[(0,metadata_resource_1().MethodMetadata)()],_metricDuration_decorators=[(0,metadata_resource_1().MethodMetadata)()],_metricErrors_decorators=[(0,metadata_resource_1().MethodMetadata)()],_metricInvocations_decorators=[(0,metadata_resource_1().MethodMetadata)()],_metricThrottles_decorators=[(0,metadata_resource_1().MethodMetadata)()],_addEventSource_decorators=[(0,metadata_resource_1().MethodMetadata)()],_configureAsyncInvoke_decorators=[(0,metadata_resource_1().MethodMetadata)()],_addFunctionUrl_decorators=[(0,metadata_resource_1().MethodMetadata)()],__esDecorate(this,null,_addAlias_decorators,{kind:"method",name:"addAlias",static:!1,private:!1,access:{has:obj=>"addAlias"in obj,get:obj=>obj.addAlias},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_addEventSourceMapping_decorators,{kind:"method",name:"addEventSourceMapping",static:!1,private:!1,access:{has:obj=>"addEventSourceMapping"in obj,get:obj=>obj.addEventSourceMapping},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_addPermission_decorators,{kind:"method",name:"addPermission",static:!1,private:!1,access:{has:obj=>"addPermission"in obj,get:obj=>obj.addPermission},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_addToRolePolicy_decorators,{kind:"method",name:"addToRolePolicy",static:!1,private:!1,access:{has:obj=>"addToRolePolicy"in obj,get:obj=>obj.addToRolePolicy},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_grantInvoke_decorators,{kind:"method",name:"grantInvoke",static:!1,private:!1,access:{has:obj=>"grantInvoke"in obj,get:obj=>obj.grantInvoke},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_grantInvokeLatestVersion_decorators,{kind:"method",name:"grantInvokeLatestVersion",static:!1,private:!1,access:{has:obj=>"grantInvokeLatestVersion"in obj,get:obj=>obj.grantInvokeLatestVersion},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_grantInvokeVersion_decorators,{kind:"method",name:"grantInvokeVersion",static:!1,private:!1,access:{has:obj=>"grantInvokeVersion"in obj,get:obj=>obj.grantInvokeVersion},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_grantInvokeUrl_decorators,{kind:"method",name:"grantInvokeUrl",static:!1,private:!1,access:{has:obj=>"grantInvokeUrl"in obj,get:obj=>obj.grantInvokeUrl},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_grantInvokeCompositePrincipal_decorators,{kind:"method",name:"grantInvokeCompositePrincipal",static:!1,private:!1,access:{has:obj=>"grantInvokeCompositePrincipal"in obj,get:obj=>obj.grantInvokeCompositePrincipal},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_metric_decorators,{kind:"method",name:"metric",static:!1,private:!1,access:{has:obj=>"metric"in obj,get:obj=>obj.metric},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_metricDuration_decorators,{kind:"method",name:"metricDuration",static:!1,private:!1,access:{has:obj=>"metricDuration"in obj,get:obj=>obj.metricDuration},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_metricErrors_decorators,{kind:"method",name:"metricErrors",static:!1,private:!1,access:{has:obj=>"metricErrors"in obj,get:obj=>obj.metricErrors},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_metricInvocations_decorators,{kind:"method",name:"metricInvocations",static:!1,private:!1,access:{has:obj=>"metricInvocations"in obj,get:obj=>obj.metricInvocations},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_metricThrottles_decorators,{kind:"method",name:"metricThrottles",static:!1,private:!1,access:{has:obj=>"metricThrottles"in obj,get:obj=>obj.metricThrottles},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_addEventSource_decorators,{kind:"method",name:"addEventSource",static:!1,private:!1,access:{has:obj=>"addEventSource"in obj,get:obj=>obj.addEventSource},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_configureAsyncInvoke_decorators,{kind:"method",name:"configureAsyncInvoke",static:!1,private:!1,access:{has:obj=>"configureAsyncInvoke"in obj,get:obj=>obj.configureAsyncInvoke},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_addFunctionUrl_decorators,{kind:"method",name:"addFunctionUrl",static:!1,private:!1,access:{has:obj=>"addFunctionUrl"in obj,get:obj=>obj.addFunctionUrl},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(null,_classDescriptor={value:_classThis},_classDecorators,{kind:"class",name:_classThis.name,metadata:_metadata},null,_classExtraInitializers),EdgeFunction2=_classThis=_classDescriptor.value,_metadata&&Object.defineProperty(_classThis,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction",version:"2.220.0"};static PROPERTY_INJECTION_ID="aws-cdk-lib.aws-cloudfront.experimental.EdgeFunction";static EDGE_REGION="us-east-1";edgeArn=__runInitializers(this,_instanceExtraInitializers);functionName;functionArn;grantPrincipal;isBoundToVpc=!1;permissionsNode;role;version;architecture;resourceArnsForGrantInvoke;_edgeFunction;constructor(scope,id,props){super(scope,id);try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudfront_experimental_EdgeFunctionProps(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,EdgeFunction2),error}(0,metadata_resource_1().addConstructMetadata)(this,props);const regionIsUsEast1=!core_1().Token.isUnresolved(this.env.region)&&this.env.region==="us-east-1",{edgeFunction,edgeArn}=regionIsUsEast1?this.createInRegionFunction(props):this.createCrossRegionFunction(id,props);this.edgeArn=edgeArn,this.functionArn=edgeArn,this._edgeFunction=edgeFunction,this.functionName=this._edgeFunction.functionName,this.grantPrincipal=this._edgeFunction.role,this.permissionsNode=this._edgeFunction.permissionsNode,this.version=lambda().extractQualifierFromArn(this.functionArn),this.architecture=this._edgeFunction.architecture,this.resourceArnsForGrantInvoke=this._edgeFunction.resourceArnsForGrantInvoke,this.node.defaultChild=this._edgeFunction}get versionRef(){return{functionArn:this.functionArn}}get functionRef(){return{functionArn:this.functionArn,functionName:this.functionName}}get lambda(){return this._edgeFunction}get currentVersion(){return this}addAlias(aliasName,options={}){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_AliasOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addAlias),error}return new(lambda()).Alias(this._edgeFunction,`Alias${aliasName}`,{aliasName,version:this._edgeFunction.currentVersion,...options})}get connections(){throw new(core_1()).ValidationError("Lambda@Edge does not support connections",this)}get latestVersion(){throw new(core_1()).ValidationError("$LATEST function version cannot be used for Lambda@Edge",this)}addEventSourceMapping(id,options){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_EventSourceMappingOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addEventSourceMapping),error}return this.lambda.addEventSourceMapping(id,options)}addPermission(id,permission){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_Permission(permission)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addPermission),error}return this.lambda.addPermission(id,permission)}addToRolePolicy(statement){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_PolicyStatement(statement)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addToRolePolicy),error}return this.lambda.addToRolePolicy(statement)}grantInvoke(identity){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_IGrantable(identity)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantInvoke),error}return this.lambda.grantInvoke(identity)}grantInvokeLatestVersion(identity){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_IGrantable(identity)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantInvokeLatestVersion),error}return this.lambda.grantInvokeLatestVersion(identity)}grantInvokeVersion(identity,version){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_IGrantable(identity),jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_IVersion(version)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantInvokeVersion),error}return this.lambda.grantInvokeVersion(identity,version)}grantInvokeUrl(identity){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_IGrantable(identity)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantInvokeUrl),error}return this.lambda.grantInvokeUrl(identity)}grantInvokeCompositePrincipal(compositePrincipal){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_CompositePrincipal(compositePrincipal)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantInvokeCompositePrincipal),error}return this.lambda.grantInvokeCompositePrincipal(compositePrincipal)}metric(metricName,props){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudwatch_MetricOptions(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.metric),error}return this.lambda.metric(metricName,{...props,region:EdgeFunction2.EDGE_REGION})}metricDuration(props){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudwatch_MetricOptions(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.metricDuration),error}return this.lambda.metricDuration({...props,region:EdgeFunction2.EDGE_REGION})}metricErrors(props){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudwatch_MetricOptions(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.metricErrors),error}return this.lambda.metricErrors({...props,region:EdgeFunction2.EDGE_REGION})}metricInvocations(props){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudwatch_MetricOptions(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.metricInvocations),error}return this.lambda.metricInvocations({...props,region:EdgeFunction2.EDGE_REGION})}metricThrottles(props){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_cloudwatch_MetricOptions(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.metricThrottles),error}return this.lambda.metricThrottles({...props,region:EdgeFunction2.EDGE_REGION})}addEventSource(source){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_IEventSource(source)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addEventSource),error}return this.lambda.addEventSource(source)}configureAsyncInvoke(options){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_EventInvokeConfigOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.configureAsyncInvoke),error}return this.lambda.configureAsyncInvoke(options)}addFunctionUrl(options){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_lambda_FunctionUrlOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addFunctionUrl),error}return this.lambda.addFunctionUrl(options)}createInRegionFunction(props){const edgeFunction=new(lambda()).Function(this,"Fn",props);return addEdgeLambdaToRoleTrustStatement(edgeFunction.role),{edgeFunction,edgeArn:edgeFunction.currentVersion.edgeArn}}createCrossRegionFunction(id,props){const parameterNamePrefix="cdk/EdgeFunctionArn";if(core_1().Token.isUnresolved(this.env.region))throw new(core_1()).ValidationError("stacks which use EdgeFunctions must have an explicitly set region",this);const sanitizedPath=this.node.path.replace(/[^\/\w.-]/g,"_"),parameterName=`/${parameterNamePrefix}/${this.env.region}/${sanitizedPath}`,functionStack=this.edgeStack(props.stackId),edgeFunction=new(lambda()).Function(functionStack,id,props);addEdgeLambdaToRoleTrustStatement(edgeFunction.role);const version=edgeFunction.currentVersion;new(ssm()).StringParameter(edgeFunction,"Parameter",{parameterName,stringValue:version.edgeArn});const edgeArn=this.createCrossRegionArnReader(parameterNamePrefix,parameterName,version);return{edgeFunction,edgeArn}}createCrossRegionArnReader(parameterNamePrefix,parameterName,version){const parameterArnPrefix=this.stack.formatArn({service:"ssm",region:EdgeFunction2.EDGE_REGION,resource:"parameter",resourceName:parameterNamePrefix+"/*"}),resourceType="Custom::CrossRegionStringParameterReader",serviceToken=cross_region_string_param_reader_provider_generated_1().CrossRegionStringParamReaderProvider.getOrCreate(this,resourceType,{policyStatements:[{Effect:"Allow",Resource:parameterArnPrefix,Action:["ssm:GetParameter"]}]});return new(core_1()).CustomResource(this,"ArnReader",{resourceType,serviceToken,properties:{Region:EdgeFunction2.EDGE_REGION,ParameterName:parameterName,RefreshToken:core_1().Lazy.uncachedString({produce:()=>{const cfn=version.node.defaultChild;return this.stack.resolve(cfn.logicalId)}})}}).getAttString("FunctionArn")}edgeStack(stackId){const stage=core_1().Stage.of(this);if(!stage)throw new(core_1()).ValidationError("stacks which use EdgeFunctions must be part of a CDK app or stage",this);const edgeStackId=stackId??`edge-lambda-stack-${this.stack.node.addr}`,parentStack=core_1().Stack.of(this);let edgeStack=stage.node.tryFindChild(edgeStackId);return edgeStack||(edgeStack=new(core_1()).Stack(stage,edgeStackId,{env:{region:EdgeFunction2.EDGE_REGION,account:core_1().Stack.of(this).account},tags:parentStack.tags.tagValues()})),this.stack.addDependency(edgeStack),edgeStack}static{__runInitializers(_classThis,_classExtraInitializers)}};return EdgeFunction2=_classThis})();exports.EdgeFunction=EdgeFunction;function addEdgeLambdaToRoleTrustStatement(role){if(iam().Role.isRole(role)&&role.assumeRolePolicy){const statement=new(iam()).PolicyStatement,edgeLambdaServicePrincipal=new(iam()).ServicePrincipal("edgelambda.amazonaws.com");statement.addPrincipals(edgeLambdaServicePrincipal),statement.addActions(edgeLambdaServicePrincipal.assumeRoleAction),role.assumeRolePolicy.addStatements(statement)}}
